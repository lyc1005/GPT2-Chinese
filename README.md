# 古诗词生成

## 方法
本项目使用了中文[GPT-2](https://d4mucfpksywv.cloudfront.net/better-language-models/language_models_are_unsupervised_multitask_learners.pdf)模型。GPT-2的核心思想就是利用transformer的decoder构建语言模型,即训练目标为对序列中所有token优化其条件概率p(s<sub>n</sub> | s<sub>1</sub>,s<sub>2</sub>,...,s<sub>n-1</sub>)。生成时，GPT-2通过前文每次预测生成一个token，本项目采用的方法是选取预测概率top10并根据相应概率抽样得到，生成的token加入前文继续输入模型生成下一个token，直到达到最大长度或古诗词创作完成

## 数据

本项目使用的数据来自[chinese-poetry: 最全中文诗歌古典文集数据库](https://github.com/chinese-poetry/chinese-poetry),该古诗词语料库包含了包含 5.5 万首唐诗、26 万首宋诗、2.1 万首宋词和其他古典文集。诗人包括唐宋两朝近 1.4 万古诗人，和两宋时期 1.5 千古词人。本项目使用了其中的唐宋诗词共311860首,处理好的数据可以从[这里](https://drive.google.com/file/d/1lIp4Dc2ge_9o3_f_BXj7sZ9zjGY88KNd/view?usp=sharing)提取

## 使用代码
如果需要复现模型结果或用模型生成古诗词，使用方法如下
```
# 加载github仓库
git clone https://github.com/lyc1005/GPT2-for-Chinese-Ancient-Poetry-Generation.git

# 安装依赖包
cd GPT2-for-Chinese-Ancient-Poetry-Generation/
pip install -r requirements.txt
mkdir /data
mkdir /model

#从Gdrive 下载数据
!wget -O data/train.json https://drive.google.com/u/0/uc?id=1lIp4Dc2ge_9o3_f_BXj7sZ9zjGY88KNd&export=download  
```
训练模型,在单个16G的P100 GPU需要花费1h8min训练1个epoch，训练6个epoch大约花费7个小时
```
python train.py --raw \
  --gradient_accumulation=4 \
  --tokenizer_path=cache/vocab_user.txt \
  --epochs=6 \
  --lr=1e-4 \
  --log_step=100 \
  --num_pieces=10 \
  --min_length=24 \
  --stride=768 \
  --batch_size=2
```
训练好的模型会在model文件夹内，也可以从[这里](https://drive.google.com/drive/folders/1mLFd8bkwFSTBgFR6hPMro87zyd2DcE4j?usp=sharing)提取训练好的模型，将Gdrive的final_model文件夹放到本地仓库的model文件夹内

生成古诗词的代码如下，通过修改prefix参数的内容可以指定古诗词的开头， 改为`--prefix=""`可以生成任意开头的古诗词
```
python generate.py \
  --model_path=model/final_model \
  --length=100 \
  --nsamples=10 \
  --batch_size=1 \
  --topk=10 \
  --topp=0 \
  --prefix="白日依山尽，" \
  --model_config=model/final_model/config.json \
  --tokenizer_path=cache/vocab_user.txt \
  --save_samples \
  --save_samples_path=./results
```

## 生成样例

- 指定开头（如：白日依山尽）

```
======================================== SAMPLE 1 ========================================
白日依山尽，清风入坐时。一川分野色，万里送春悲。落日空馀霭，浮云不可期。
==========================================================================================

======================================== SAMPLE 2 ========================================
白日依山尽，青山入梦中。人家犹可见，鸟语亦相通。世俗多难识，时人有此风。
==========================================================================================

======================================== SAMPLE 3 ========================================
白日依山尽，春风落照明。孤山明晚照，孤笛起寒声。独夜孤灯里，孤灯照晓行。孤吟如昨梦，愁绝不成清。
==========================================================================================

======================================== SAMPLE 4 ========================================
白日依山尽，黄尘入眼看。一川归路好，五马入关寒。野鸟鸣山屋，春禽出谷坛。故园无限好，时复到南轩。
==========================================================================================

======================================== SAMPLE 5 ========================================
白日依山尽，青山独往还。青云不相似，白发不相关。野寺僧来静，寒灯鸟自閒。何时见真趣，此地是禅关。
==========================================================================================

======================================== SAMPLE 6 ========================================
白日依山尽，寒烟带月生。江声寒不尽，山色暮初清。远客心相慰，新诗兴自横。
==========================================================================================

======================================== SAMPLE 7 ========================================
白日依山尽，黄昏见月明。青山千古色，白鸟一川声。不见青山好，应愁白发生。
==========================================================================================

======================================== SAMPLE 8 ========================================
白日依山尽，青松古涧长。云中看不足，云外有馀香。
==========================================================================================

======================================== SAMPLE 9 ========================================
白日依山尽，青山独见天。一溪寒影落，数曲暮声传。野寺寒侵竹，山窗落照莲。相过不相问，时作故人缘。
==========================================================================================

======================================== SAMPLE 10 ========================================
白日依山尽，孤云一径长。寒烟生晚色，春草入空芳。不是愁人意，空怜旅客肠。相看如一日，相望独凄凉。
==========================================================================================
```
- 不指定开头

```
======================================== SAMPLE 1 ========================================
万里无端一段心，十分光景一番新。无情风物能相似，一片清风自在人。
==========================================================================================

======================================== SAMPLE 2 ========================================
不见黄花满眼红。不知人在西园里，更无言语向春风。
==========================================================================================

======================================== SAMPLE 3 ========================================
一片青春万朵青，一枝花下水西汀。春光淡淡烟无际，水面清光日正晶。
==========================================================================================

======================================== SAMPLE 4 ========================================
山林野寺半荒林，野老逢秋亦懒吟。山路不容行脚远，溪云自合在心心。山行未觉山中远，野渡空看水上深。不是江湖多故人，一樽相对不能斟。
==========================================================================================

======================================== SAMPLE 5 ========================================
山中一迳入云深，不是人间有好音。
==========================================================================================

======================================== SAMPLE 6 ========================================
昔日相思意已阑，相看已过眼前看。不知今日经行乐，且喜新诗为我寒。但见山阴生晚霭，更无诗思到江干。故园欲寄无消息，更向溪头把钓竿。
==========================================================================================

======================================== SAMPLE 7 ========================================
昔闻天禄，不见汉家。今来不知，不及人花。今年年年年，今日花又发。今年十五六七二，今年二分好时好。今年三过三十日，明年一日是今日。今年二十日，不见十日一日好。今年四十九十七，今年八十七二十四七。今日春夏
==========================================================================================

======================================== SAMPLE 8 ========================================
天地一番新，地势三日雨。水色四山明，云烟万顷白。我行山水间，此是天宇窄。我行山水村，我行不可息。
==========================================================================================

======================================== SAMPLE 9 ========================================
一生不到，一生无住。
==========================================================================================

======================================== SAMPLE 10 ========================================
君王未必知其事，君子方今有几人。
==========================================================================================
```

## Citing

```
@misc{GPT2-Chinese,
  author = {Zeyao Du},
  title = {GPT2-Chinese: Tools for training GPT2 model in Chinese language},
  year = {2019},
  publisher = {GitHub},
  journal = {GitHub repository},
  howpublished = {\url{https://github.com/Morizeyao/GPT2-Chinese}},
}
```
